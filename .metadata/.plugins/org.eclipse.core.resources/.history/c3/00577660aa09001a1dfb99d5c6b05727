<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form"%>
<%@ page session="true"%>
<meta charset="UTF-8">
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
	integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
	crossorigin="anonymous">

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
	integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
	crossorigin="anonymous"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
	integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
	crossorigin="anonymous"></script>
<script
	src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
	integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
	crossorigin="anonymous"></script>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<!-- <script src="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css"></script>
<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script> -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.20/datatables.min.css"/>
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.20/datatables.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<!DOCTYPE html>
<html>
<head>
<title>WebBoard - 통계 페이지</title>
</head>
<body>
<script type="text/javascript">
	$(document).ready(function() {
	    $('#logTable').DataTable();
	} );
</script>
	<div class="row">
		<div class="jumbotron">
			  <h2 class="display-4">통계 페이지입니다.</h2>
 				 <p class="lead">접속자별 통계, 접속자별 브라우저 통계, 접속자별 운영체제 통계, 접속 시간별 그래프를 조회할 수 있습니다.</p>
  				 <a class="btn btn-primary btn-lg" href="${pageContext.request.contextPath }/boardList.do?page_no=1&pageSize=10" role="button">돌아가기</a>
		</div>
	</div>
	<div class="row">
		</br>
		</br>
	</div>
	<div class="row">
		<div class="col-8" style="margin-left:10px">
			<table id="logTable" class="display" style="width:100%; margin-left:20px;">
				<thead class="thead-dark">
					<tr>
						<th scope="col">No</th>
						<th scope="col">ID</th>
						<th scope="col">Date</th>
						<th scope="col">IP</th>
						<th scope="col">Browser</th>
						<th scope="col">Browser Ver.</th>
						<th scope="col">OS</th>
						<th scope="col">Refer</th>
						<th scope="col">Tool</th>
					</tr>
				</thead>
				<tbody>
					<c:forEach var="log" items="${logList }" varStatus="status">
						<tr>
							<th scope="row">${status.index + 1 }</th>
							<td><strong>${log.log_userid }</strong></td>
							<td>${log.log_date }</td>
							<td>${log.log_userip }</td>
							<td><strong>${log.log_userbrowser }</strong></td>
							<td>${log.log_bversion }</td>
							<td><strong>${log.log_osversion }</strong></td>
							<td>${log.log_userreferrer }</td>
							<td>
								<button type="button" id="logDelete${log.log_no}" class="btn btn-danger btn-sm" onClick="logDelete(${log.log_no});">제거하기</button>
							</td>
						</tr>
					</c:forEach>
				</tbody>
			</table>
			<form action="${pageContext.request.contextPath }/Chart.do" method="get">
				<input type="text" name="date" id="datepicker" readonly="readonly">
				<input type="submit" class="btn btn-primary" value="조회"/>
				<button type="button" class="btn btn-info" onclick="location.href='${pageContext.request.contextPath}/Chart.do?date='">전체조회하기</button>
			</form>
			<script>
				$('#datepicker').datepicker({
					dateFormat: 'yy-mm-dd'
				});
			</script>
			<canvas id="logTimeChart" style="width: 700px, height: 300px"></canvas></br>
			<canvas id="logTimeTotalChart" style="width: 700px, height: 300px"></canvas>
		</div>
		<div class="col">
			<h5 style="text-align: center;">유저별 접속 횟수 그래프</h5>
			<canvas id="logNameChart" style="width: 600px; height: 400px;"></canvas></br>
			<h5 style="text-align: center;">운영체제별 접속 횟수 그래프</h5>
			<canvas id="logOSChart" style="width: 600px; height: 400px;"></canvas></br>
			<h5 style="text-align: center;">브라우저별 접속 횟수 그래프</h5>
			<canvas id="logBrowserChart" style="width: 600px; height: 400px;"></canvas></br>
			<div class="row">
			
			</div>
			<div class="row">
			
			</div>
		</div>
	</div>
	<script>
		function logDelete(log_no) {
			$.ajax({
				type : "POST",
				url : "/logDelete.do",
				data : {"log_no" : log_no},
				dataType : "json",
				success : function(result) {
					alert('삭제가 완료되었습니다.');
					location.reload();
				},
				error : function(error) {
					alert('에러 발생');
				}
			});
		}
		
		function colorize() {
			var r = Math.floor(Math.random()*200);
			var g = Math.floor(Math.random()*200);
			var b = Math.floor(Math.random()*200);
			var color = 'rgb(' + r + ', ' + g + ', ' + b + ')';
			return color;
		}
		
		/* 이름별 리스트 정리 시작 */
		var jsonData = ${json}
		var jsonObject = JSON.stringify(jsonData);
		var jData = JSON.parse(jsonObject);
		
		var labelList = new Array();
		var valueList = new Array();
		var colorList = new Array();
		
		for(var i = 0; i<jData.length; i++) {
			var d = jData[i];
			labelList.push(d.ID);
			valueList.push(d.Count);
			colorList.push(colorize());
		}
		
		
		var data = {
						labels: labelList,
						datasets: [{
								backgroundColor: colorList,
								data : valueList
						}],
						options : {
								title : {
									display : true,
									text: '유저별 접속 횟수'
								}
						}
		};
		
		var ctx1 = document.getElementById('logNameChart').getContext('2d');
		new Chart(ctx1, {
			type: 'pie',
			data: data
		});
		/* 이름별 리스트 정리 끝 */
		
		
		/* OS별 리스트 정리 시작 */
		var jsonDataOS = ${jsonOS};
		var jsonObjectOS = JSON.stringify(jsonDataOS);
		var jDataOS = JSON.parse(jsonObjectOS);
		
		var labelListOS = new Array();
		var valueListOS = new Array();
		var colorListOS = new Array();
		
		for(var i = 0; i<jDataOS.length; i++) {
			var o = jDataOS[i];
			labelListOS.push(o.OS);
			valueListOS.push(o.Count);
			colorListOS.push(colorize());
		}
		
		var data2 = {
						labels : labelListOS,
						datasets: [{
							backgroundColor : colorListOS,
							data : valueListOS
						}],
						options : {
							title : {
								display : true,
								text : '운영체제별 접속 횟수'
							}
						}
		};
		
		var ctx2 = document.getElementById('logOSChart').getContext('2d');
		new Chart(ctx2, {
			type:'pie',
			data : data2
		})
		/* OS별 리스트 끝 */
		
		/* 브라우저별 리스트 시작 */
		var jsonDataBrowser = ${jsonBrowser};
		var jsonObjectBrowser = JSON.stringify(jsonDataBrowser);
		var jDataBrowser = JSON.parse(jsonObjectBrowser);
		
		var labelListBrowser = new Array();
		var valueListBrowser = new Array();
		var colorListBrowser = new Array();
		
		for(var i = 0; i<jDataBrowser.length; i++) {
			var b = jDataBrowser[i];
			labelListBrowser.push(b.Browser);
			valueListBrowser.push(b.Count);
			colorListBrowser.push(colorize());
		}
		
		var data3 = {
						labels : labelListBrowser,
						datasets: [{
							label : '접속 횟수',							
							backgroundColor : colorListBrowser,
							data : valueListBrowser
						}],
						options : {
							title : {
								display : true,
								text : '운영체제별 접속 횟수'
							}
						}
		};
		
		var ctx3 = document.getElementById('logBrowserChart').getContext('2d');
		new Chart(ctx3, {
			type:'pie',
			data : data3
		})
		/* 브라우저별 리스트 끝 */
		
		/* 시간별 리스트 시작 */
		var jsonDataTime = ${jsonTime};
		var jsonObjectTime = JSON.stringify(jsonDataTime);
		var jDataTime = JSON.parse(jsonObjectTime);
		
		var labelListTime = new Array();
		var valueListTime = new Array();
		var colorListTime = new Array();
		
		for(var i = 0; i<jDataTime.length; i++) {
			var t = jDataTime[i];
			labelListTime.push(t.DateTime);
			valueListTime.push(t.Count);
			colorListTime.push(colorize());
		}
		
		var data4 = {
						labels : labelListTime,
						datasets: [{
							label : '시간대별 접속자 수',
							data : valueListTime,
							backgroundColor: colorListTime
						}]
		};
		
		var ctx4 = document.getElementById('logTimeChart').getContext('2d');
		new Chart(ctx4, {
			type : 'bar',
			data : data4,
			options: {
				scales: {
					yAxes: [{
						ticks: {
							beginAtZero : true
						}
					}]
				}
			}
		})
		/* 시간별 리스트 끝 */
		
		/* 토탈 타임 리스트 시작 */
		var jsonDataDate = ${jsonDate};
		var jsonObjectDate = JSON.stringify(jsonDataDate);
		var jDataDate = JSON.parse(jsonObjectDate);
		
		var labelListDate = new Array();
		var valueListDate = new Array();
		
		for(var i = 0; i<jDataDate.length; i++) {
			var date = jDataDate[i];
			labelListDate.push(date.Date);
			valueListDate.push(date.Count);
		}
		
		var data5 = {
						labels : labelListDate,
						datasets : [{
							label : '날짜별 접속자 수',
							data : valueListDate,
							borderColor: 'rgba(255, 201, 14, 1)',
							backgroundColor : 'rgba(255, 201, 14, 0.5)',
							fill : true,
							lineTension : 0
						}]
		};
		
		var dateOptions = {
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString : '날짜'
						}
					}],
					yAxes: [{
						display: true,
						ticks: {
							suggestedMin: 0,
						},
						scaleLabel:{
							display : true,
							labelString: '횟수'
						}
					}]
				}
		}
		
		var ctx5 = document.getElementById('logTimeTotalChart').getContext('2d');
		new Chart(ctx5, {
			type: 'line',
			data: data5,
			options: dateOptions
		})
		</script>
</body>
</html>